/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovider","ojs/ojcomponentcore","ojs/ojeventtarget"],function(t,e,r){"use strict";function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function i(t,e,r){return e&&s(t.prototype,e),r&&s(t,r),t}var n=function(){function e(t){a(this,e),this.dataProvider=t,this.CacheAsyncIterable=function(){return function t(e,r,s){var i=this;a(this,t),this._parent=e,this.dataProviderAsyncIterator=r,this.cache=s,this[Symbol.asyncIterator]=function(){return new i._parent.CacheAsyncIterator(i._parent,i.dataProviderAsyncIterator,i.cache)}}}(),this.CacheAsyncIterator=function(){function t(e,r,s){a(this,t),this._parent=e,this.asyncIterator=r,this.cache=s,this._cachedOffset=0,this._iteratedOffset=0}return i(t,[{key:"next",value:function(){var t,e=this,r=this,a=this._parent._lastFetchParams,s=a.size?a.size:-1;if(-1==s){if(this.cache.isDone())return t=this.cache.getDataList(a,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t))}else{if(this.cache.getSize()>=this._cachedOffset+s||this.cache.isDone())return t=this.cache.getDataList(a,this._cachedOffset),this._cachedOffset=this._cachedOffset+t.data.length,this._cachedOffset<this.cache.getSize()||!this.cache.isDone()?Promise.resolve(new this._parent.CacheAsyncIteratorYieldResult(t)):Promise.resolve(new this._parent.CacheAsyncIteratorReturnResult(t));if(this._cachedOffset>0)return new Promise(function(t,e){if(r._iteratedOffset<r._cachedOffset){return function e(){return r.asyncIterator.next().then(function(a){if(r._iteratedOffset=r._iteratedOffset+a.value.data.length,!(r._iteratedOffset>=r._cachedOffset||a.done))return e();t()})}()}t()}).then(function(){return e.asyncIterator.next().then(function(t){return r._iteratedOffset=r._iteratedOffset+t.value.data.length,r._cachedOffset=r._iteratedOffset,r.cache.addListResult(t),t.done?new r._parent.CacheAsyncIteratorReturnResult(t.value):new r._parent.CacheAsyncIteratorYieldResult(t.value)})})}return this.asyncIterator.next().then(function(t){return r._iteratedOffset=r._iteratedOffset+t.value.data.length,r._cachedOffset=r._iteratedOffset,r.cache.addListResult(t),t.done?new r._parent.CacheAsyncIteratorReturnResult(t.value):new r._parent.CacheAsyncIteratorYieldResult(t.value)})}}]),t}(),this.CacheAsyncIteratorYieldResult=function(){return function t(r){a(this,t),this.value=r,this[e._VALUE]=r,this[e._DONE]=!1}}(),this.CacheAsyncIteratorReturnResult=function(){return function t(r){a(this,t),this.value=r,this[e._VALUE]=r,this[e._DONE]=!0}}();var s=this;this.cache=new r.DataCache,this._lastFetchParams=null,t.createOptimizedKeyMap&&(this.createOptimizedKeyMap=function(e){return t.createOptimizedKeyMap(e)}),t.createOptimizedKeySet&&(this.createOptimizedKeySet=function(e){return t.createOptimizedKeySet(e)}),t.addEventListener(e._MUTATE,function(t){s.cache.processMutations(t.detail),s.dispatchEvent(t)}),t.addEventListener(e._REFRESH,function(t){s.cache.reset(),s.dispatchEvent(t)})}return i(e,[{key:"containsKeys",value:function(t){var e=new Set,r=new Set,a=this.cache.getDataByKeys(t);if(t.keys.forEach(function(t){a.results.get(t)?e.add(t):r.add(t)}),0==r.size)return Promise.resolve({containsParameters:t,results:e});var s={attributes:t.attributes,keys:r,scope:t.scope};return this.dataProvider.containsKeys(s).then(function(r){return r.results.forEach(function(t){e.add(t)}),{containsParameters:t,results:e}})}},{key:"fetchByKeys",value:function(t){var e=new Map,r=new Set,a=this.cache.getDataByKeys(t);if(t.keys.forEach(function(t){var s=a.results.get(t);s?e.set(t,s):r.add(t)}),0==r.size)return Promise.resolve({fetchParameters:t,results:e});var s={attributes:t.attributes,keys:r,scope:t.scope};return this.dataProvider.fetchByKeys(s).then(function(r){return r.results.forEach(function(t,r){e.set(r,t)}),{fetchParameters:t,results:e}})}},{key:"fetchByOffset",value:function(t){var r=t.size?t.size:e._DEFAULT_SIZE;if(this._compareLastFetchParameters(t)&&t.offset+r<this.cache.getSize()){var a=JSON.parse(JSON.stringify(t));a.size=r;var s=this.cache.getDataByOffset(a);if(s)return Promise.resolve(s)}return this.dataProvider.fetchByOffset(t)}},{key:"fetchFirst",value:function(t){this._compareLastFetchParameters(t)||this.cache.reset(),this._storeLastFetchParams(t);var e=this.dataProvider.fetchFirst(t);return new this.CacheAsyncIterable(this,e[Symbol.asyncIterator](),this.cache)}},{key:"getCapability",value:function(t){var e=this.dataProvider.getCapability(t);return"fetchCapability"===t?{attributeFilter:e.attributeFilter,caching:"visitedByCurrentIterator"}:e}},{key:"getTotalSize",value:function(){return!this._lastFetchParams.filterCriterion&&this.cache.isDone()?Promise.resolve(this.cache.getSize()):this.dataProvider.getTotalSize()}},{key:"isEmpty",value:function(){return!this._lastFetchParams.filterCriterion&&this.cache.isDone()?0===this.cache.getSize()?"yes":"no":this.dataProvider.isEmpty()}},{key:"_compareLastFetchParameters",value:function(e){return e=e||{},null!=this._lastFetchParams&&t.Object.compareValues(this._lastFetchParams.attributes,e.attributes||null)&&t.Object.compareValues(this._lastFetchParams.filterDef,this._getFilterDef(e.filterCriterion))&&t.Object.compareValues(this._lastFetchParams.sortCriteria,e.sortCriteria||null)}},{key:"_storeLastFetchParams",value:function(t){t=t||{},this._lastFetchParams={},this._lastFetchParams.size=t.size,this._lastFetchParams.attributes=t.attributes?JSON.parse(JSON.stringify(t.attributes)):null,this._lastFetchParams.filterDef=this._getFilterDef(t.filterCriterion),this._lastFetchParams.sortCriteria=t.sortCriteria?JSON.parse(JSON.stringify(t.sortCriteria)):null}},{key:"_getFilterDef",value:function(t){if(!t)return null;var e={};return Object.keys(t).forEach(function(r){"filter"!=r&&(e[r]=t[r])}),e}}]),e}();
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return n._KEY="key",n._KEYS="keys",n._DATA="data",n._STARTINDEX="startIndex",n._SORT="sort",n._SORTCRITERIA="sortCriteria",n._FILTERCRITERION="filterCriterion",n._METADATA="metadata",n._ITEMS="items",n._FROM="from",n._OFFSET="offset",n._REFRESH="refresh",n._MUTATE="mutate",n._SIZE="size",n._FETCHPARAMETERS="fetchParameters",n._VALUE="value",n._DONE="done",n._RESULTS="results",n._CONTAINSPARAMETERS="containsParameters",n._DEFAULT_SIZE=25,n._CONTAINSKEYS="containsKeys",n._FETCHBYKEYS="fetchByKeys",n._FETCHBYOFFSET="fetchByOffset",n._FETCHFIRST="fetchFirst",n._ADDEVENTLISTENER="addEventListener",n._FETCHATTRIBUTES="attributes",t.CachedIteratorResultsDataProvider=n,t.CachedIteratorResultsDataProvider=n,t.EventTargetMixin.applyMixin(n),n});